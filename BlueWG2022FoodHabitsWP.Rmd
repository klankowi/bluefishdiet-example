---
title: 'SARC XX Bluefish (*Pomatomus saltatrix*) Working Paper YY: Food Habits'
author: James Gartland, Virginia Institute of Marine Science; Sarah K. Gaichas, Northeast
  Fisheries Science Center; Kevin R. Spanik, South Carolina Department of Natural
  Resources
date: "DRAFT `r format(Sys.time(), '%d %B, %Y')`"
output:
  word_document: default
  html_document:
    code_fold: hide
link-citations: yes
csl: plos.csl
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)
library(here)
library(DT)
library(pdftools)
library(patchwork)
library(ggiraph)

library(webshot)
if(is.null(webshot:::find_phantom())){webshot::install_phantomjs()}

options(DT.options = list(pageLength = 100))

```

# LITERATURE REVIEW

Bluefish (*Pomatomus saltatrix*) are a commercially and recreationally valuable species occurring commonly in the Northwest Atlantic from Florida to the Gulf of Maine (Bigelow and Schroeder 1953). Spawning of multiple cohorts occurs in shelf waters of the South Atlantic Bight (SAB) from Florida to Cape Hatteras during the Spring, and the Middle Atlantic Bight (MAB) from Cape Hatteras to Cape Cod during the Summer (Kendall and Walford, 1979). Limited SAB spawning may also occur in the fall (McBride et. al, 1993) as adults return south. Larval development occurs offshore during a northeast movement associated with the Gulf Stream before crossing shelf waters as temperatures rise in late-Spring (Kendall and Walford, 1979). While the processes that dictate success and timing of larval and juvenile recruitment can be highly variable, especially for migratory species that spawn over a wide spatial and temporal range (Houde, 2008), several studies exist on Bluefish recruitment in the SAB and MAB. Nyman and Conover, (1988) show that juveniles appear in estuarine waters of the MAB in mid to late June at an average age of approximately 60 days, having obtained a length of 40-70mm FL. After spending the summer in the estuaries, most of these juveniles return to sea and move southward along the coast and out of the MAB, however some juveniles from the summer spawning in the MAB remain in coastal waters while others may re-enter estuaries briefly (Kendall and Walford, 1979).

During oceanic larval development, diets are composed primarily of copepods and fish eggs in the smaller size classes (<30mm) expanding to amphipods, and crab larvae above this size (Marks and Conover, 1993). An onset to piscivory occurs for early juveniles, primarily inhibited by mouth-gape size, in estuarine waters leading to rapid increases in growth rates with maximum rates reaching 2 mm/day (Juanes and Conover, 1994). This is among the highest growth rate reported for juvenile fishes of any species. Reported daily consumption rates for age-0 fish can approach 33% body weight (Juanes and Conover, 1994). Additionally, Buckel et al. (1996) observed gastric evacuation rates, expressed as time to 90% evacuation, ranging from ~5h at 30⁰C to ~10h at 21⁰C. This suggests that bluefish are capable of feeding 2-4 times per day.

Adult Bluefish are voracious predators, predominantly consuming fishes but also preying on a broad variety of invertebrates. Studies suggest that for certain prey such as boreal and long-finned squid and butterfish, high bluefish populations are capable of removing more biomass than human-directed fisheries targeting the same species (Buckel et al., 1999c). Larger bluefish have been shown to consume larger mean prey-sizes (Sharf et al., 2004), while prey capture success has been reported to decline linearly with increasing prey length/predator length ratio (Buckel et al., 1998). Bluefish are visual predators (Olla et al., 1985), and it has been shown that feeding correlates highly with daylight periods.

Bluefish can have significant affects on populations of other commercially and recreationally valuable species. Natural mortality for young-of-year striped bass in the Hudson River has been attributed almost entirely to Bluefish predation (Buckel et al 1999a), however there is little evidence to support competition for resources between these two species (Buckel and McCown 2002). Cannibalism has also been documented, and therefore bluefish predation may influence recruitment of conspecifics (Bell et al., 1999). Increased predation on commercially important invertebrates such as blue crabs (Callinectes sapidus) may occur when fish prey are less available (Scharf et al., 2004).

Both seasonal and inter-annual differences in diet have been observed. These differences are likely attributed to differences in prey availability, but also due to inter-annual variability in timing of estuarine arrival (Nyman and Conover, 1988). Feeding may also be constrained by thermal gradients (Olla et al., 1985).

# RELEVANT SURVEY WORK AND SUPPORTING DATA

## Northeast Fisheries Science Center (NEFSC)

NEFSC bottom-trawl sampling occurs twice annually in the spring (March-May) and fall (September-November). The survey area encompasses about 293,000 square km of continental shelf from Cape Hatteras, NC, to Nova Scotia, Canada in depths from 8-400 m. Food habits sampling has been conducted since 1973, and bluefish have been collected as a "secondary" priority species from 1977-1980 and from 1985-present (Smith and Link, 2010). Bluefish stomachs are collected in small (<30 cm), medium (31-70 cm), and large (>70 cm) size strata. Over 4,500 bluefish stomachs have been collected to date from over 1,400 survey tows. Predator length ranged in size from 3 to 118 cm. Stomachs are collected at sea by NEFSC, and have been primarily analyzed at sea since 1981. Total stomach volume is estimated, each prey item is identified and sorted to the lowest possible taxonomic level, and the proportion of each prey item is estimated. Detailed methods are described in Link and Almeida (2000).  

In this analysis, we examined data for the Mid-Atlantic and Southern New England regions where bluefish are most commonly encountered. We analyzed data in 10 year blocks; in those blocks the proportion of empty stomachs ranged from 20-40%. In each ten year period, around 60-70 bluefish prey items were identified. Anchovies are significant prey of bluefish across all time periods, as are butterfish and squids (Figure 1. Other prey have different levels of importance across time, including sandlances, herrings, bluefish, and scup (which has increased in the past two decades). Drums have also recently increased in bluefish diets. 

Prey composition percent by weight as shown in Figure 1 \ref{fig:NEFSCdecade} was calculated using a weighted mean ($\overline{w_{ijs}}$) (Link and Almeida, 2000) to estimate mean weight of prey $i$ in predator $j$ for statistical group $s$. Note: Prey volumes are used as proxies for prey weight. It may be calculated as


$$\overline{w_{ijs}} = \frac{\sum_{t=1}^{N_{ts}} N_{jts}\overline{w_{ijts}}}{N_{ts}}$$


where $t$ represents an individual bottom trawl tow, $N_{jts}$ is the number of predator $j$ stomachs in tow $t$ for statistical group $s$, $N_{ts}$ is the number of tows in statistical group $s$, and 

$$\overline{w_{ijts}} = \frac{\sum_{k=1}^{N_{jts}} \overline{w_{ijtsk}}}{N_{jts}}$$ 

## NEFSC 2022 Update

For the 13 October 2021 Bluefish WG meeting, we pulled summary diet information from the [NEFSC Diet Data shiny app, Fish Trophic Ecology of the Northeast U.S. Continental Shelf, by Smith B.E. & Rowe S., dated 9/20/2021](https://fwdp.shinyapps.io/tm2020/). These data were pulled 7 October 2021 and were saved in the `datfromshiny` folder in [this repository](https://github.com/sgaichas/bluefishdiet).

## NEFSC Results

### Bluefish as prey; NEFSC bottom trawl survey

```{r}

bluefishpreds <- read_csv(here("datfromshiny","WEW.Bluefish (Pomatomus saltatrix).2021-10-07.csv"))

totobs <- sum(bluefishpreds$Frequency)
dompred <- bluefishpreds$Predator[which.max(bluefishpreds$Frequency)]
pctdompred <- max(bluefishpreds$Frequency)/totobs*100

```
The NEFSC bottom trawl survey has relatively few records of bluefish as prey (Table 1).  From 1973-2020, `r totobs` bluefish were identified as prey in fish sampled for diet. Of these, `r dompred` had the most bluefish in stomachs; `r pctdompred`% of all observed.

### Bluefish as prey; literature

Quick research found the following links showing that (adult) bluefish are eaten by [mako sharks](https://web.uri.edu/wetherbee/predator-prey-interactions-between-mako-sharks-isurus-oxyrinchus-and-bluefish-pomatomus-saltatrix/) (Tony Wood, primary author) and have been found in [swordfish](http://www.int-res.com/articles/meps/22/m022p239.pdf) diets.

We found one paper looking at [bluefish cannibalism on juveniles](https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1095-8649.1999.tb00734.x); but nothing else on consumption of juvenile bluefish by predators. There may be more info. We looked at bluefish diets for a previous benchmark assessment and did see some cannibalism; see Fig B5.7, p.522 of [this doc](https://repository.library.noaa.gov/view/noaa/4975)).

### Bluefish as predators

#### NEFSC bottom trawl survey diet summaries

Here we show a subset of summaries. For interactive plots with downloadable tables, please see  https://sgaichas.github.io/bluefishdiet/DietSummary.html

Diet summaries from the shiny app use different prey categories depending on the summary. This is a list of unique prey across all summaries for NEFSC plots in this document; these represent the most common prey categories for Bluefish in the NEFSC dataset. 
```{r, readdiets}
bluefishaggdiet <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).All.2021-10-07.csv"))

# decadal diet
diet70 <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).1970s.2021-10-07.csv")) %>%
  mutate(Decade = 1970)
diet80 <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).1980s.2021-10-07.csv"))%>%
  mutate(Decade = 1980)
diet90 <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).1990s.2021-10-07.csv"))%>%
  mutate(Decade = 1990)
diet00 <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).2000s.2021-10-07.csv"))%>%
  mutate(Decade = 2000)
diet10 <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).2010s.2021-10-07.csv"))%>%
  mutate(Decade = 2010)

bluefishdecadediet <- bind_rows(diet70, diet80, diet90, diet00, diet10)

# seasonal diet
dietspring <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).SPRING.2021-10-07.csv"))%>%
  mutate(Season = "Spring")
dietfall <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).FALL.2021-10-07.csv"))%>%
  mutate(Season = "Fall")

bluefishseasondiet <- bind_rows(dietspring, dietfall)

# regional diet
dietMAB <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).MID-ATLANTIC BIGHT.2021-10-07.csv")) %>%
  mutate(Region = "MAB")
dietSNE <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).SOUTHERN NEW ENGLAND.2021-10-07.csv"))%>%
  mutate(Region = "SNE")
dietGB <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).GEORGES BANK.2021-10-07.csv"))%>%
  mutate(Region = "GB")

bluefishregiondiet <- bind_rows(dietMAB, dietSNE, dietGB)

# bluefish size diet
dietSM <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).S.2021-10-07.csv")) %>%
  mutate(Size = "Small")
dietMED <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).M.2021-10-07.csv"))%>%
  mutate(Size = "Medium")
dietLG <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).L.2021-10-07.csv"))%>%
  mutate(Size = "Large")

bluefishsizediet <- bind_rows(dietSM, dietMED, dietLG)

preylist <- unique(c(bluefishaggdiet$Prey, bluefishdecadediet$Prey, bluefishregiondiet$Prey, bluefishseasondiet$Prey, bluefishsizediet$Prey))

```

We will define the colors used for the prey categories and use them consistently throughout the analyses. In the online version of this summary, click a bar to get that bar highlighted with a prey name.

```{r}
#from http://medialab.github.io/iwanthue/ using 35 categories, colorblind friendly
# again from http://medialab.github.io/iwanthue/ All colors colorspace, colorblind friendly, hard
preycol <- c("#00495d",
"#3ac100",
"#a646f7",
"#72ff75",
"#8d00a6",
"#c6ff90",
"#0268f1",
"#ff8d23",
"#0144a6",
"#01a249",
"#e1009e",
"#abffe1",
"#7e0082",
"#fffdd4",
"#24001c",
"#bbf6ff",
"#a60029",
"#0176c8",
"#8a4700",
"#a083ff",
"#454400",
"#ff7fff",
"#005d35",
"#c9005e",
"#00483e",
"#ff96e4",
"#291d00",
"#d5a5ff",
"#2e0400",
"#ffc5d6",
"#00285f",
"#ffbb88",
"#4a002e",
"#ff8092",
"#68001a")
names(preycol) <- as.factor(preylist)

```

Figure 1. \ref{fig:NEFSCdecade} shows changes in prey categories by decade for Bluefish from the NEFSC diet database, as updated from the 2015 SAW 60 Working Paper.

Supplemental figures and tables with Bluefish diet overall, by season, by region, and by size category from the NEFSC diet database are available at the end of this document and online.

## Virginia Institute of Marine Science (VIMS) – NEAMAP & ChesMMAP  

The Virginia Institute of Marine Science (VIMS) conducts two fishery-independent bottom trawl surveys; namely, the Chesapeake Bay Multispecies Monitoring and Assessment Program (ChesMMAP) and Northeast Area Monitoring and Assessment Program, Mid-Atlantic/Southern New England (NEAMAP M-A/SNE) Trawl Surveys.  Both programs are designed as multispecies surveys and collect bluefish for diet analysis, and other biological data, throughout their spatial and temporal ranges.  ChesMMAP samples the mainstem of the Chesapeake Bay from Poole’s Island, MD to the Virginian Capes, and collects bluefish from throughout the bay during the May, July, September, and November cruises, which reflects the temporal residency of this species in the estuary.  The ChesMMAP Trawl Survey has been sampling the Chesapeake Bay since 2002.  NEAMAP has been sampling the nearshore waters of the Mid-Atlantic Bight and Southern New England since the fall of 2007.  This survey conducts two cruises per year, one in the spring and one in the fall, mirroring the efforts of the NEFSC Bottom Trawl Survey offshore.  Sampling occurs from Martha’s Vineyard, MA, to Cape Hatteras, NC, and between the 18m and 36m depth contours to the north and east of Montauk, NY, and the 6m and 18m contours to the south and west.  It is worth noting that the offshore extent of the NEAMAP effort aligns with the inshore extent of the NEFSC survey.  Bluefish are collected from both spring and fall cruises and throughout the sampling area.  

Bluefish stomach samples collected at sea by ChesMMAP and NEAMAP are labeled and preserved in Normalin®.  Processing occurs at the shore-based laboratories at VIMS.  Stomach samples for both surveys were analyzed according to standard procedures (Hyslop 1980). Specifically, each stomach was individually weighed (0.001 g), the contents were emptied, the empty stomach was weighed, and all prey items were identified to the lowest possible taxonomic level. Each item was then enumerated, weighed (0.001 g), and individual length measurements (0.1mm) were taken when possible. 

It is well known that fishes distribute in temporally and spatially varying aggregations. The biological and ecological characteristics of a particular fish species collected by fishery-independent sampling activities inevitably reflect this underlying spatio-temporal structure. Intuitively, it follows then that the diets (and other biological parameters) of individuals captured by a single gear deployment (e.g., ChesMMAP or NEAMAP tow) will be more similar to one another than to the diets of individuals captured at a different time or location (Bogstad et al. 1995).

Under this assumption, the diet indices percent by weight (%W) and percent by number (%N) for bluefish can be represented using a cluster sampling estimator since, as implied above, trawl collections essentially yield a cluster (or clusters if multiple size groups are sampled) of the species at each sampling site. The equation for $\%W$ of prey type $k$ is given by (Bogstad et al. 1995, Buckel et al. 1999):

$$\%W_{k}=\frac{\sum_{i=1}^n M_iq_{ik}}{\sum_{i=1}^nMi}*100$$                                  (1)

where

$$q_{ik}= \frac{w_{ik}}{w_i}$$                              		                (2)

and where $n$ is the total number of clusters collected of the fish species of interest, $M_i$ is the number of that species collected in cluster $i$, $w_i$ is the total weight of all prey items encountered in the stomachs of the fish collected and processed from cluster $i$, and $w_{ik}$ is the total weight of prey type $k$ in these stomachs. Estimation of %Nk uses the same equation by replacing the biomass values with count data.  These cluster estimators were used to quantify the diet compositions of the bluefish collected by NEAMAP and ChesMMAP. While the diet descriptions provided reflect a combination of data collected across years for each survey, presentations of diet by sub-area, year, cruise, size, age, etc., are possible.


## NEAMAP Results

The number of bluefish sampled annually for diet analysis has ranged from 403 to 666 specimens, covering the 6.5 to 78.5 cm FL size range (Figure 2).  A total of 4,250 bluefish have been sampled for diet by this program to date, and 56.0% (2,379 fish) of these have had prey items in their stomach.

Overall, NEAMAP staff encountered 86 prey types in the 2,379 bluefish stomachs that contained prey to date (Table 1).  It is worth noting that NEAMAP staff have processed all stomach samples collected since the inception of the program; no backlog of samples exists.  The diet of bluefish collected by NEAMAP as given by the %W index shows that fishes were the main prey of this species in the nearshore waters of the Mid-Atlantic and Southern New England regions (Figure 3; Table 1).  Fishes comprised greater than 96% of the bluefish diet by weight, with bay anchovy (53.9%), butterfish (7.4%), and striped anchovy (6.2%) accounting for the bulk of the prey consumed.  For the invertebrates, the longfin inshore squid was the main identifiable prey type.   

A similar picture of bluefish diet, as defined by the sampling efforts of the NEAMAP Trawl Survey, was given using the %N index (Figure 3; Table 1).  Fishes contributed 92.6% of the diet as measured by this index, and the same three fishes identified by the %W index dominated the diets of bluefish.  Invertebrates were shown to be slightly more important in the bluefish diet using %N, likely due the large numbers of small-bodied invertebrates (e.g., crab megalope and mysid shrimps) that were encountered on several occasions.

## ChesMMAP Results
Sample sizes for diet from ChesMMAP have ranged from 8 to 74 bluefish annually, and fish from 11.9 to 53.7 cm FL (Figure 4) were collected.  A total of 443 bluefish have been sampled for diet from this survey since 2002, and 54.0% of these have had prey items in their stomach.  Although sample size and the size-distribution of bluefish are somewhat small, this survey likely provides a useful representation of the diet composition of bluefish in the bay, as large bluefish have been absent from the Chesapeake for several decades.

ChesMMAP scientists encountered 34 prey types in the 239 bluefish stomachs that they have analyzed to date (Table 2).  Like NEAMAP, this program has processed all stomach samples collected since the inception of the program.  Fishes again dominated the diet of bluefish collected from Chesapeake Bay, as measured using the %W index (Figure 5; Table 2).  Fishes comprised approximately 87.7% of the bluefish diet by weight, with bay anchovy (39.9%), spot (18.8%), and Atlantic menhaden (9.1%) accounting for the bulk of the fishes consumed by bluefish.  Silver perch and weakfish each accounted for 2.4% of the diet by weight.  Of the invertebrates, the mysid shrimp was the main identifiable prey type.   

Fishes comprised nearly the same percentage of the bluefish diet when measured by the %N index (Figure 5; Table 2).  Fishes contributed 84.6% of the diet by number, while invertebrates accounted for 13.7%.  The remainder was unidentifiable items.  Overall then, the diet of bluefish both in the Chesapeake Bay and the coastal ocean, from Cape Cod to Cape Hatteras, is dominated by fishes, regardless of the index by which the diet is quantified.  These findings correspond with those of past studies that have sought to characterize bluefish diet in estuarine and ocean environments.


## *REPRINTED FROM 2015, NO UPDATE FOR 2020* South Carolina Department of Natural Resources (SCDNR) – Southeast Area Monitoring and Assessment Program  - South Atlantic (SEAMAP-SA):

SEAMAP-SA fishery-independent Coastal Trawl Survey bottom-trawl sampling occurs annually in the Spring (Mid-April to end of May), Summer (Mid-July to Mid-August), and Fall (October to Mid-November). The survey area encompasses the shallow coastal waters from Cape Hatteras, North Carolina to Cape Canaveral, Florida at depths from 4 to 10 m.  Bluefish stomachs and otoliths were collected from 2011 through 2013. In total, 644 stomachs were collected, 487 of which (75.6%) contained prey items. Predator length ranged in size from 4.8 cm FL to 44.1 cm FL. The narrow range in length frequency distribution may likely be explained by research showing that Bluefish are a highly migratory species and utilize nearshore waters of the southeast Atlantic as a nursery for larval and juvenile stages before migrating northward (Kendall and Walford, 1979), or may be a function of gear selectivity or capture efficiency mechanisms, since bluefish swimming energetics can surpass standard survey tow speed and duration (Freadman, 1979). Additionally, bluefish are a pelagic species and generally occur in surface waters; habitat not efficiently sampled with bottom trawls.

Stomachs are collected at sea by SEAMAP, labeled and preserved in a 10% buffered formalin solution for a maximum of two weeks. After this time, the stomachs are removed from the formalin solution, rinsed with tap water, and then immersed in 70% EtOH. For each stomach, all extraneous organ tissue was removed and the whole stomach, including contents, was weighed (0.001 g). Contents were emptied, sorted to the lowest possible taxon, weighed (0.001 g) and measured (0.1 mm) when possible. 

Diet composition for each prey item by %W and %N as calculated using the cluster sampling estimator described above is presented in Table 3 and Figure 7.

A total of 49 different types of prey were identified (Table 3). The length of the largest whole, intact prey item consumed by bluefish in this study was 94 mm, however bluefish commonly sever their prey and whole prey were rarely encountered. Estimates on original body length inferred from partial remains have been investigated (Scharf et. al 1997), and may be useful in future studies.  Bluefish diet composition by weight consisted primarily of fishes (93.5%), most significantly anchovies (49.8%), Atlantic Bumper (3.2%), and sciaenid fishes (1.2%) (Figure 7; Table 3). Penaeid shrimp, loliginid squids and cubozoan jellyfish contributed in highest proportions among the invertebrates (Figure 7; Table 3). A similar composition is depicted by our %N calculations.

# Literature cited/Additional sources pertaining to Bluefish food habits

Able, K.W. Burlas, M., and D. Byrne. 2003. Use of ocean and estuarine habitats by young-of-year bluefish (*Pomatomus saltatrix*) in the New York Bight. Fishery Bulletin, 101: 201-214.

Bell, G.W., Buckel, J.A., and A.W. Stoner. 1999. Effects of alternative prey on cannibalism in age-1 bluefish. Journal of Fish Biology, 55: 990-1000.

Bigelow, H. B. and W.C. Schroeder. 1953. Fishes of the Gulf of Maine. U.S. Fish Wildl. Serv., Fish Bull. 53, p. 577.

Bogstad, B., M. Pennington, and J.H. Volstad. 1995. Cost-efficient survey designs for estimating food consumption by fish. Fisheries Research. 23(1-2): 37-46.

Buchheister, A. and R.J. Latour. 2015. Diets and trophic-guild structure of a diverse fish assemblage in Chesapeake Bay, U.S.A. Journal of Fish Biology, 86(3): 967-992.

Buckel, J.A., Steinberg, N.D., and D.O. Conover. 1995. Effects of temperature, salinity, and fish size on growth and consumption of juvenile bluefish. Journal of Fish Biology, 47: 696-706.

Buckel, J.A. and D.O. Conover. 1996. Gastric Evacuation Rates of Piscivorous Young-of-the-Year Bluefish. Transactions of the American Fisheries Society, 125(4): 591-599.

Buckel, J.A. and D.O. Conover. 1997. Movement, feeding periods, and daily ration of piscivorous young-of-the-year bluefish, Pomatomus saltatrix, in the Hudson River estuary. Fishery Bulletin, 95: 665-660.

Buckel, J.A., Letcher, B.H., and D.O. Conover. 1998. Effects of a Delayed Onset of Piscivory on the Size of Age-0 Bluefish. Transactions of the American Fisheries Society, 127: 576-587.

Buckel, J.A., Conover, D.O., Steinberg, N.D., and K.A. McKown. 1999a. Impact of age-0 bluefish (*Pomatomus saltatrix*) predation on age-0 fishes in the Hudson River estuary: evidence for density-dependent loss of juvenile striped bass (*Morone saxatilis*). Canadian Journal of Fisheries and Aquatic Sciences, 56: 275-287.

Buckel, J.A., M.J. Fogarty, and D.O. Conover. 1999b. Foraging habits of bluefish, *Pomatomus saltatrix*, on the U.S. east coast continental shelf. Fishery Bulletin, 97: 758-775.

Buckel, J.A., M.J. Fogarty, and D.O. Conover. 1999c. Mutual prey of fish and humans: a comparison of biomass consumed by bluefish, *Pomatomus saltatrix*, with that harvested by fisheries. Fishery Bulletin, 97: 776-785.

Buckel, J.A. and A.W. Stoner. 2000. Functional response and switching behavior of young-of-the-year piscivorous bluefish. Journal of Experimental Marine Biology and Ecology, 245: 25-41.

Buckel, J.A. and K.A. McKown. 2002. Competition between juvenile striped bass and bluefish: resource partitioning and growth rate. Marine Ecology Progress Series, 234: 191-204.

Buckel, J.A., Pessutti, J.P., Rosendale, J.E., and J.S. Link. 2009. Interactions between bluefish and striped bass: Behavior of bluefish under size-and-number-impaired conditions and overlap in resources use. Journal of Experimental Marine Biology and Ecology, 368: 129-137.

Creaser, E.P. and H.C. Perkins. 1994. The distribution, food, and age of juvenile bluefish, *Pomatomus saltatrix*, in Maine. Fishery Bulletin, 92: 494-508.

Friedland, K.D., Garman, G.C., Bejda, A.J., Studholme, A.L., and B. Olla. 1988. Interannual Variation in Diet and Condition in Juvenile Bluefish during Estuarine Residency. Transactions of the American Fisheries Society, 117: 474-479.

Fry, B. 1988. Food web structure on Georges Bank from stable C, N, and S isotopic compositions. Limnology and Oceanography, 33(5): 1182-1190.

Garrison, L.P. 2000. Spatial and dietary overlap in the Georges Bank groundfish community. Canadian Journal of Fisheries and Aquatic Sciences, 57: 1679-1691.

Garrison, L.P. and J.S. Link. 2000. Dietary guild structure of the fish community in the Northeast United States continental shelf ecosystem. Marine Ecology Progress Series, 202: 231-240.

Gartland, J., Latour, R.J., Halvorson, A.D., and H.M. Austin. 2006. Diet Composition of Young-of-the-Year Bluefish in the Lower Chesapeake Bay and the Coastal Ocean of Virginia. Transactions of the American Fisheries Society, 135: 371-378.

Grant, G.C. 1962. Predation of bluefish on young Atlantic menhaden in India River, Delaware. Chesapeake Science, 3(1): 45-47.

Harding, J.M. and R. Mann. 2001. Diet and habitat use by bluefish, *Pomatomus saltatrix*, in a Chesapeake Bay estuary. Environmental Biology of Fishes, 60: 401-409.

Hartman, K.J. and S.B. Brandt. 1995. Trophic Resource Partitioning, Diets, and Growth of Sympatric Estuarine Predators. Transactions of the American Fisheries Society, 124: 520-537.

Houde, E.D. 1995. Emerging from Hjort’s shadow. Journal ofNorthwest Atlantic Fishery Science, 41: 53-70.

Hyslop, E.J. 1980. Stomach content analysis--a review of methods and their application. Journal of Fish Biology. 17: 411-429.

Juanes, F.,  Marks, R.E., McKown, K.A., and D.O. Conover. 1993. Predation by Age-0 Bluefish on Age-0 Anadromous Fishes in the Hudson River Estuary. Transactions of the American Fisheries Society, 122: 348-356.

Juanes, F and D.O. Conover. 1994. Rapid Growth, High Feeding Rates, and Early Piscivory in Young-of-the-Year Bluefish (*Pomatomus saltatrix*). Canadian Journal of Fisheries and Aquatic Sciences, 51: 1752-1761.

Juanes, F., Buckel, J.A., and D.O. Conover. 1994. Accelerating the onset of piscivory: intersection of predator and prey phenologies. Journal of Fish Biology, 45: 41-54.

Juanes, F. and D.O. Conover. 1995. Size-structured piscivory: advection and the linkage between predator and prey recruitment in young-of-the-year bluefish. Marine Ecology Progress Series, 128: 287-304.

Juanes, F., Buckel, J.A. and F.S. Scharf. 2001. Predatory behavior and selectivity of a primary piscivore: comparison of fish and non-fish prey. Marine Ecology Progress Series, 217: 157-165.

Kendal, A. W. and L.A. Walford. 1979. Sources and distribution of Bluefish, *Pomatomus saltatrix*, larvae and juveniles off the east coast of the United States. Fishery Bulletin, 77(1): 213-227.

Lassiter, R.R. 1962. Life history of the bluefish, *Pomatomus saltatrix* (Linnea us), from the coast of North Carolina. M.S. thesis, N.C. State Univ., Raleigh. p. 60-103.

Link and Almeida 2000. An Overview and History of the Food Web Dynamics Program of the Northeast Fisheries Science Center, Woods Hole, Massachusetts. US Dep Commer, NOAA Tech Memo NMFS NE 159; 60 p. Available at http://www.nefsc.noaa.gov/publications/tm/tm159/

Lucena, F.M., Vaske Jr., T., Ellis, J.R., and C.M. O’Brien. 2000. Seasonal variation in the diets of bluefish, *Pomatomus saltatrix* (Pomatomidae) and striped weakfish, *Cynoscion guatacupa* (Sciaenidae) in southern Brazil: implications of food partitioning. Environmental Biology of Fishes, 87: 423-434.

Marancik, K. E. and J.A. Hare. 2007. Large scale patterns in fish trophodynamics of estuarine and shelf habitats of the Southeast United States. Bulletin of Marine Science, 80(1): 67-91.

Marks, R. E. and D.O. Conover. 1993. Ontogenetic shift in the diet of young-of-year bluefish *Pomatomus saltatrix* during the oceanic phase of the early life history. Fishery Bulletin, 91: 97-106.

McBride, R. S., Ross, J.L., and D.O. Conover. 2003. Recruitment of bluefish *Pomatomus saltatrix* to estuaries of the U.S. South Atlantic Bight. Fishery Bulletin, 91(2): 389-395.

Moustahfid, H., Tyrrell, M.C., and J.S. Link. 2009. Accounting for Predation Mortality in Surplus Production Models: an Application to Longfin Inshore Squid. North American Journal of Fisheries Management, 29: 1555-1566.

Neuman, M.J., Guillermo, R., and W. Able. 2004. Species Composition and Food Habits of Dominant Fish Predators in Salt Marshes of an Urbanized Estuary, the Hackensack Meadowland, New Jersey. Urban Habitats 2(1): 62-82.

Nyman, R. R. and D.O. Conover. 1988. The relation between spawning season and the recruitment of young-of-the-year bluefish to New York. Fishery Bulletin, 86: 237-250.

Olla, B.L., Studholme, A.L., and A.J. Bejda. 1985. Behavior of juvenile bluefish *Pomatomus saltatrix* in vertical thermal gradients: influence of season, temperature acclimation and food. Marine Ecology Progress Series, 23: 165-177

Richards, S.W. 1976. Age, Growth, and Food of Bluefish (*Pomatomus saltatrix*) from East-Central Long Island Sound from July through November 1975. Transactions of the American Fisheries Society, 105(4): 523-525.

Sagarese, S.R., Cerrato, R.M., and M.G. Frisk. 2011. Diet Composition and Feeding Habits of Common Fishes in Long Island Bays, New York. Northeastern Naturalist, 18(3): 291-314.

Scharf, F.S., Buckel, J.A., Juanes, F., and D.O. Conover. 1997. Estimating piscine prey size from partial remains: testing for shifts in foraging mode by juvenile bluefish. Environmental Biology of Fishes, 49: 377-388.

Scharf, F.S., Buckel, J.A., Juanes, F., and D.O. Conover. 1998. Predation by juvenile piscivorous bluefish (*Pomatomus saltatrix*): the influence of prey to predator size ratio and prey type on predator capture success and prey profitability. Canadian Journal of Fisheries and Aquatic Sciences, 55: 1695-1703.

Scharf, F.S., Manderson, J.P., Fabrizio, M.C., Pessutti, J.P. Rosendale, J.E., Chant, R.J., and A.J. Bejda. 2004. Seasonal and Interannual Patterns of Distribution and Diet of Bluefish within a Middle Atlantic Bight Estuary in Relation to Abiotic and Biotic Factors. Estuaries, 27(3): 428-436.

Scharf, F.S., Buckel, J.A., Rose, K.A., Juanes, F., and J.H. Cowan Jr. 2006. Effects of Variable Prey and Cohort Dynamics on Growth of Young-of-the-Year Estuarine Bluefish: Evidence for Interactions between Spring- and Summer-Spawned Cohorts. Transactions of the American Fisheries Society, 135: 1266-1289.

Scharf, F.S., Buckel, J.A., and F. Juanes. 2009. Contrasting patterns of resource utilization between juvenile estuarine predators: the influence of relative prey size and foraging ability on the ontogeny of piscivory. Canadian Journal of Fisheries and Aquatic Sciences, 66: 790-801.

Smith and Link 2010. The trophic dynamics of 50 fish and 2 squid species on the Northeast US continental shelf. NOAA Tech Memo NMFS-NE-216, 640 p. Available at http://www.nefsc.noaa.gov/publications/tm/tm216/tm216.pdf

Staudinger, M.D. 2006. Seasonal and size-based predation on two species of squid by four fish predators on the Northwest Atlantic continental shelf. Fishery Bulletin, 104(4): 605-615.

Szczebak, J.T. and D.L. Taylor. 2011. Ontogenetic patterns in Bluefish (*Pomatomus saltatrix*) feeding ecology and the effect on mercury biomagnification. Environmental Toxicology and Chemistry, 30(6): 1447-1458.

Woodland, R.J. and D.H. Secor. 2011. Differences in juvenile trophic niche for two coastal fish species that use marine and estuarine nursery habitats. Marine Ecology Progress Series, 439: 241-254.

Woodland, R.J. and D.H. Secor. 2013. Benthic-pelagic coupling in a temperate inner continental shelf fish assemblage. Limnology and Oceanography, 58(3): 966-976.

Wuenschel, M.J., Able, K.W., Vasslides, J.M., and D.M. Byrne. 2013. Habitat and diet overlap of 4 piscivorous fishes: variation on the inner continental shelf off New Jersey.  Fisheries Bulletin, 111: 352-369.


# Tables

```{r}
#datatable(bluefishpreds[,-c(1:2)], rownames = FALSE,
knitr::kable(bluefishpreds[,-c(1:2)], rownames = FALSE,          
          caption = 'Table 1: Who eats bluefish on the NEFSC bottom trawl survey. Nstom is total stomachs sampled for the predator, 1973-2020.')
```


# Figures

```{r, fig.cap="Key to prey colors in NEFSC summaries"}
dfpreycol <- as.data.frame(preycol) %>%
  rownames_to_column(var = "preyname")

preycolplot <- ggplot(dfpreycol, aes(x=preyname, weight=1, fill=preycol)) + 
  geom_bar() +
  scale_fill_manual(values=preycol) 

# see https://stackoverflow.com/questions/43366616/ggplot2-legend-only-in-a-plot
library(gridExtra)
library(grid)
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

preykey <- g_legend(preycolplot)
grid.draw(preykey)

```

```{r NEFSCdecade, fig.cap="Bluefish diet by decade (all regions and bluefish sizes)"}
p <- ggplot(bluefishdecadediet, aes(x=as.factor(Decade), y=Pct.m, fill=Prey)) +
  geom_bar_interactive(width = 0.95, stat = "identity", show.legend = FALSE,
                       aes(tooltip = Prey, data_id = Prey))+
  scale_fill_manual(values=preycol) +         #custom colors
  ggthemes::theme_tufte()
#ggiraph(code=print(p))

p
```

# Supplemental Figures

## NEFSC 

#### Bluefish diet in aggregate (all years, regions, and bluefish sizes), 1973-2020 {.tabset}

##### Plot
```{r}
p <- ggplot(bluefishaggdiet, aes(x=as.factor("Aggregate"), y=Pct.m, fill=Prey)) +
  geom_bar_interactive(width = 0.95, stat = "identity", show.legend = FALSE,
                       aes(tooltip = Prey, data_id = Prey))+
  scale_fill_manual(values=preycol) +         #custom colors
  ggthemes::theme_tufte()
ggiraph(code=print(p))
```

##### Table
```{r}
datatable(bluefishaggdiet[,-c(1:2, 10)], rownames = FALSE,
          caption = 'Table 3: Bluefish prey from all samples combined.')
```

#### {-}

#### Bluefish diet by season (all years, regions, and bluefish sizes) {.tabset}

##### Plot
```{r}
p <- ggplot(bluefishseasondiet, aes(x=as.factor(Season), y=Pct.m, fill=Prey)) +
  geom_bar_interactive(width = 0.95, stat = "identity", show.legend = FALSE,
                       aes(tooltip = Prey, data_id = Prey))+
  scale_fill_manual(values=preycol) +         #custom colors
  ggthemes::theme_tufte()
ggiraph(code=print(p))
```

##### Table
```{r}
datatable(bluefishseasondiet[,-c(1:2, 10)], rownames = FALSE,
          caption = 'Table 4: Bluefish prey by season, 1973-2020.')
```

#### {-}

#### Bluefish diet by decade (all regions and bluefish sizes) {.tabset} 

##### Plot
```{r}
p <- ggplot(bluefishdecadediet, aes(x=as.factor(Decade), y=Pct.m, fill=Prey)) +
  geom_bar_interactive(width = 0.95, stat = "identity", show.legend = FALSE,
                       aes(tooltip = Prey, data_id = Prey))+
  scale_fill_manual(values=preycol) +         #custom colors
  ggthemes::theme_tufte()
ggiraph(code=print(p))
```

##### Table
```{r}
datatable(bluefishdecadediet[,-c(1:2, 10)], rownames = FALSE,
          caption = 'Table 5: Bluefish prey by decade, 1973-2020.')
```

#### {-}

#### Bluefish diet by region (all years and bluefish sizes) {.tabset}  

##### Plot
```{r}
p <- ggplot(bluefishregiondiet, aes(x=as.factor(Region), y=Pct.m, fill=Prey)) +
  geom_bar_interactive(width = 0.95, stat = "identity", show.legend = FALSE,
                       aes(tooltip = Prey, data_id = Prey))+
  scale_fill_manual(values=preycol) +         #custom colors
  ggthemes::theme_tufte()
ggiraph(code=print(p))
```

##### Table
```{r}
datatable(bluefishregiondiet[,-c(1:2, 10)], rownames = FALSE,
          caption = 'Table 6: Bluefish prey by region, 1973-2020.')
```

#### {-}

#### Bluefish diet by bluefish size (all years and regions) {.tabset}

Bluefish size categories: Small = 10-30 cm; Medium = 31-70 cm; Large = >70 cm

##### Plot
```{r}
p <- ggplot(bluefishsizediet, aes(x=as.factor(Size), y=Pct.m, fill=Prey)) +
  geom_bar_interactive(width = 0.95, stat = "identity", show.legend = FALSE,
                       aes(tooltip = Prey, data_id = Prey))+
  scale_fill_manual(values=preycol) +         #custom colors
  ggthemes::theme_tufte()
ggiraph(code=print(p))

```

##### Table
```{r}
datatable(bluefishsizediet[,-c(1:2, 10)], rownames = FALSE,
          caption = 'Table 7: Bluefish prey by bluefish size, 1973-2020.')
```

#### {-}

### Bluefish annual diet by season (1973-2016)

Initial test food habits dataset from [2018 ECSA](https://github.com/NOAA-EDAB/ECSA/blob/master/data/allfhsg.RData) has food habits 1973 to 2016. Will get fuller up to date info from Brian Smith shortly.

This is the `get_diet()` function from [ECSA](https://github.com/NOAA-EDAB/ECSA/blob/master/R/get_diet.R), modified to use all available strata:

```{r, get_diet}
#' Get diet composition data for plotting
#'
#' Creates a dataset for plotting annual or seasonal weighted diet composition with sample sizes.
#' Datasets are for a selected species and set of seasonal survey strata.
#' Currently only works for summer flounder with strata pre-selected.
#' Need to clearly define what each data column is, render to tidy data.
#' This is a first draft that will be revised with dplyr functions later.
#' n.b., Original file from Brian Smith, August 23 2018 was allwt_nstoms.R, renamed as get_diet.R
#'
#'
#' @param species_code numeric. Three digit svspp code
#'
#' @return dataframe with variables svspp, year, season, meansw, num_tows, variance, cv, prey, totwt, relmsw, ci, relci, nstom
#'
#' @examples
#' head(get_diet(103))
#'

get_diet <- function(species_code){
  
  #### This part here should be replaced with a file for all NEUS stocks
  # sss <- read.csv("data/seasonal_stock_strata.csv",
  #                 stringsAsFactors = FALSE)
  # 
  # sixcode <- c('acared','alewif','amepla','atlcod','atlhal','atlher','atlmac','atlwol',
  #              'barska','blabas','bluefi','bluher','butter','cleska','haddoc',
  #              'litska','monkfh','ocpout','offhak','polloc','redhak','rosska',
  #              'scupzz','silhak','smodog','smoska','spidog','sumflo','thoska',
  #              'whihak','window','winflo','winska','witflo','yelflo','amlobs','joncra')
  # 
  # svspp_list <- c(155,33,102,73,101,32,121,192,22,141,
  #                 135,34,131,24,74,26,197,193,69,
  #                 75,77,25,143,72,13,27,15,103,
  #                 28,76,108,106,23,107,105,301,312)
  # 
  # 
  # #Get data, manipulate, set constants
  # svspp_df <- data.frame(sp = sixcode,
  #                        svspp = svspp_list, 
  #                        stringsAsFactors = FALSE)
  # 
  # seasonal_strata <- sss %>% 
  #   mutate(season = toupper(season)) %>% 
  #   left_join(svspp_df, by = "sp") %>% 
  #   rename(stratum = strata) %>% 
  #   filter(svspp %in% species_code)


  # seasonal_strata <- read.csv("data/stock_list.csv", stringsAsFactors = FALSE) %>% 
  #   dplyr::select(season,
  #                 sp = species_code,
  #                 stock_area = stock,
  #                 stratum = strat,
  #                 svspp) %>% 
  #   dplyr::filter(svspp == species_code,
  #                 season %in% c("fall", "spring")) %>% 
  #   dplyr::mutate(season = toupper(season))
  
  
  ## Need to figure out how to access via ERDDAP
  #load("data/allfhsg.RData")
  
  load(here("fhdat", "allfhsg_2016.RData"))
  
  # spring_strata <- seasonal_strata$stratum[seasonal_strata$season == 'SPRING']
  # summer_strata <- seasonal_strata$stratum[seasonal_strata$season == 'SUMMER']
  # fall_strata <-   seasonal_strata$stratum[seasonal_strata$season == 'FALL']
  # winter_strata <- seasonal_strata$stratum[seasonal_strata$season == 'WINTER']
  
  ## Filter out only good stomachs for strata and species
  allsum_raw <- allfhsg %>%
    filter(pynam != 'BLOWN', 
           pynam != 'PRESERVED',
           pynam != ' ',
           purcode == 10, 
           svspp %in% species_code)#,
           # (season == "SPRING" & stratum %in% spring_strata) |
           #   (season == "SUMMER" & stratum %in% summer_strata) |
           #   (season == "FALL"   & stratum %in% fall_strata)   |
           #   (season == "WINTER" & stratum %in% winter_strata))
  
  ## Number of stomachs by length and weight
  
  ## Sum by length
  allsum_len <- allsum_raw %>%
    group_by(year,
             season,
             svspp,
             cruise,
             station,
             pdid,
             pdsex,
             pdlen) %>%
    summarise(totwt = sum(pyamtw)) %>%
    na.omit() %>%
    group_by(year,
             season,
             svspp) %>%
    summarise(nstom    = n(),
              meanstom = mean(totwt, na.rm = TRUE),
              varstom  = var(totwt, na.rm = TRUE),
              meanlen  = mean(pdlen, na.rm = TRUE),
              numlen   = n(),
              minstom  = min(totwt, na.rm = TRUE),
              maxstom  = max(totwt, na.rm = TRUE),
              minlen   = min(pdlen, na.rm = TRUE),
              maxlen   = max(pdlen, na.rm = TRUE))
  
  ## Sum by weight
  allsum_wgt <- allsum_raw %>%
    group_by(year,
             season,
             svspp,
             cruise,
             station,
             pdid,
             pdsex,
             pdwgt,
             pdlen) %>%
    summarise(totwt = sum(pyamtw, na.rm = TRUE)) %>%
    na.omit() %>%
    group_by(year,
             season,
             svspp) %>%
    summarise(meanwgt = mean(pdwgt, na.rm = TRUE),
              numwgt  = n(),
              minwgt  = min(pdwgt, na.rm = TRUE),
              maxwgt  = max(pdwgt, na.rm = TRUE))
  
  #stomstats2
  nstom_df <- allsum_len %>%
    left_join(allsum_wgt, by = c("year", "season", "svspp")) %>%
    # mutate(std.error = sqrt(varstom/nstom)) %>% 
    select(svspp, year, season, nstom)
  
  #----------------------------------Start weighted diet proportion code-------------------------------------#
  
  ## Select and rename the appropriate columns
  allsum_strat <- allsum_raw %>%
    select(cruise6, stratum, station, 
           year,
           season,
           svspp, pdid, 
           pdsex, pdlen, 
           tax = collsci, 
           pyamt = pyamtw, 
           catnum, numlen, 
           tot_catnum_stratum, tot_catwgt_stratum, tot_tows_spp_stratum, 
           stratum_area)
  
  ## Group into seasonal length-class and remove NAs
  num_strat <- allsum_strat %>%
    group_by(cruise6,
             station,
             year,
             season,
             svspp,
             pdid,
             pdsex,
             pdlen) %>%
    summarise(xxxx = n()) %>%
    group_by(cruise6,
             station, 
             year,
             season, 
             svspp, 
             pdsex, 
             pdlen) %>%
    summarise(numlen2 = n()) %>%
    left_join(allsum_strat,  by = c("cruise6", "station", "year",
                                    "season", "svspp", "pdsex", "pdlen")) %>% 
    mutate(numlen_fin = case_when(numlen < numlen2 ~ numlen2,
                                  numlen >= numlen2 ~ numlen,
                                  TRUE ~ NA_integer_)) %>%
    select(c(cruise6, stratum, station,
             year,
             season, 
             svspp, pdid, pdsex, pdlen, tax, pyamt, 
             catnum, tot_catnum_stratum, tot_catwgt_stratum,
             tot_tows_spp_stratum, stratum_area, numlen, numlen_fin))
  
  
  sum_strat <- num_strat %>%
    group_by(cruise6,
             station, 
             year, 
             season,
             svspp, 
             pdsex,
             pdlen, 
             numlen_fin) %>%
    summarise(dummy_var = sum(numlen, na.rm = TRUE)) %>% 
    na.omit() %>%
    group_by(cruise6,
             station, 
             year, 
             season, 
             svspp, 
             pdlen) %>%
    summarise(rnumlen_fin = sum(numlen_fin, na.rm = TRUE)) %>%
    left_join(num_strat, by = c("cruise6", "station", "year", "season", "svspp", "pdlen")) %>% 
    mutate(rnumlen_fin = ifelse(svspp !=13 | svspp !=15, 
                                numlen_fin, 
                                rnumlen_fin)) %>%
    group_by(cruise6, 
             station,
             year,
             season,
             svspp, 
             pdsex, 
             catnum) %>%
    summarise(dummy_var = sum(numlen)) %>% 
    na.omit()
  
  
  sum_catnum <- sum_strat %>%
    group_by(cruise6,
             station, 
             year,
             season,
             svspp) %>%
    summarise(rcatnum = sum(catnum, na.rm = TRUE)) %>%
    na.omit() %>%
    left_join(num_strat,  by = c("cruise6", "station", "year", "season", "svspp")) %>% 
    mutate(rcatnum = ifelse(svspp != 13 | svspp != 15, 
                            catnum, 
                            rcatnum))
  
  sum_catstratum <- sum_catnum %>%
    group_by(cruise6, stratum, 
             year,
             season, 
             svspp, 
             pdsex, 
             tot_tows_spp_stratum,
             tot_catnum_stratum,
             tot_catwgt_stratum) %>%
    summarise(dum_var = sum(rcatnum, na.rm = TRUE)) %>%
    na.omit()
  
  ####################################################################################################################################
  
  max_tot_tows_spp_stratum <- sum_catstratum %>%
    group_by(cruise6, 
             stratum, 
             year,
             season,
             svspp) %>% 
    summarise(tot_tows_spp_stratum = max(tot_tows_spp_stratum, na.rm = TRUE))
  
  sum_rcatstratum <- sum_catstratum %>%
    group_by(cruise6, 
             stratum, 
             year,
             season,
             svspp) %>%
    summarise(rtot_catnum_stratum = sum(tot_catnum_stratum, na.rm = TRUE),
              rtot_catwgt_stratum = sum(tot_catwgt_stratum, na.rm = TRUE)) %>% 
    na.omit() %>%
    left_join(max_tot_tows_spp_stratum, by = c("cruise6", "stratum", "year", "season", "svspp")) %>%
    rename(rtot_tows_spp_stratum = tot_tows_spp_stratum)
  
  final_strat <- sum_rcatstratum %>%
    left_join(sum_catnum, by = c("cruise6", "stratum", "year", "season", "svspp")) %>% 
    mutate(rtot_catnum_stratum = ifelse(svspp != 13 | svspp != 15, 
                                        tot_catnum_stratum, 
                                        rtot_catnum_stratum),
           rtot_catwgt_stratum = ifelse(svspp != 13 | svspp != 15, 
                                        tot_catwgt_stratum, 
                                        rtot_catwgt_stratum),
           rtot_tows_spp_stratum = ifelse(svspp != 13 | svspp != 15, 
                                          tot_tows_spp_stratum,
                                          rtot_tows_spp_stratum))
  
  ####################################################################################################################################
  py_raw <- final_strat %>%
    group_by(cruise6, 
             station, 
             year,
             season, 
             svspp, pdid, pdlen, tax) %>%
    summarise(pysum = sum(pyamt, na.rm = TRUE)) %>% 
    na.omit() 
  
  py_nostom <- py_raw %>%
    ungroup() %>% 
    arrange(cruise6, station,
            year,
            season,
            svspp,
            pdid) %>%
    group_by(cruise6,
             station, 
             year,
             season, 
             svspp, 
             pdid) %>% 
    top_n(-1, wt = pysum) %>%
    group_by(cruise6, 
             station, 
             year, 
             season, 
             svspp) %>%
    summarise(nostom = n())
  
  py_list <- data.frame(tax = unique(py_raw$tax),
                        pycode = paste0('prey', 1:length(unique(py_raw$tax))))
  
  
  py_all <- py_nostom %>%
    left_join(py_raw, by = c("cruise6", "station", "year", "season", "svspp")) %>% 
    left_join(py_list, by = "tax")
  
  
  pd_strat <- final_strat %>%
    group_by(cruise6, 
             station, 
             year,
             season,
             svspp, 
             pdid, 
             pdlen) %>% 
    top_n(-1, wt = stratum_area) 
  
  
  pd_nas <- pd_strat %>%
    group_by(cruise6, 
             station, 
             year,
             season,
             svspp, 
             pdlen) %>%
    summarise(rnumlen_fin = sum(numlen_fin, na.rm = TRUE)) %>%
    na.omit()
  
  pd_strat <- pd_strat %>%
    left_join(pd_nas, by = c("cruise6", "year", "season", "svspp", "station", "pdlen")) %>% 
    select(cruise6, station, stratum, 
           year,
           season,
           svspp, pdid, pdlen,
           rcatnum, rtot_catnum_stratum,
           tot_catwgt_stratum, rtot_catwgt_stratum,
           rtot_tows_spp_stratum, stratum_area, rnumlen_fin)
  
  #Working with fish data.frame----------------------------------------------------------------------------------#
  fish_ply <- py_all %>%
    select(-tax) %>% 
    left_join(pd_strat, by = c("cruise6", "station", "year", "season", "svspp", "pdid", "pdlen"))
  
  
  ####################################################################################################################################
  ## Take the median value for each prey group
  trans_ply <- fish_ply %>%
    group_by(cruise6, stratum, station,
             year, season, 
             svspp, rcatnum,
             rtot_catnum_stratum, 
             rtot_catwgt_stratum,
             rtot_tows_spp_stratum,
             stratum_area, rnumlen_fin, pycode) %>%
    summarize(pysum = median(pysum, na.rm = FALSE))
  
  ## Weighted mean and mean of pysum
  pysum_wm <- trans_ply %>%
    group_by(cruise6, stratum, station, 
             year, season,
             svspp, rcatnum, 
             rtot_catnum_stratum,
             rtot_tows_spp_stratum,
             stratum_area, pycode) %>% 
    summarize(wmean = weighted.mean(pysum, w = rnumlen_fin))# %>%
  
  ## Mean
  pysum_m <- pysum_wm %>%
    group_by(cruise6, stratum, station,
             year, season,
             svspp, rcatnum,
             rtot_catnum_stratum,
             rtot_tows_spp_stratum,
             stratum_area,
             pycode) %>%
    summarize(musw = mean(wmean, na.rm = TRUE),
              musw2 = wmean * rcatnum)
  
  ## by station
  pysum_wm_s <- pysum_m %>%
    group_by(cruise6, stratum, 
             year, season,
             svspp,
             rtot_catnum_stratum,
             rtot_tows_spp_stratum,
             stratum_area, 
             pycode) %>% 
    summarize(tmsw_strat = sum(musw2, na.rm = TRUE))
  
  musw_strat_ply <- pysum_wm_s %>% 
    group_by(cruise6, stratum, 
             year, season,
             svspp,
             rtot_catnum_stratum,
             rtot_tows_spp_stratum,
             stratum_area, 
             pycode) %>% 
    summarize(musw_strat = tmsw_strat/rtot_tows_spp_stratum) %>%
    ungroup() %>%
    mutate(munfish_strat = rtot_catnum_stratum / rtot_tows_spp_stratum)
  
  
  munfish_stratdat_ply <- musw_strat_ply %>%
    ungroup() %>%
    mutate(munfish_strat = rtot_catnum_stratum / rtot_tows_spp_stratum) %>%
    select(cruise6, stratum,
           year, season,
           svspp, munfish_strat)
  
  
  #weight by stratum area
  pymean_strat <- musw_strat_ply %>% 
    group_by(svspp, year, season,
             pycode) %>% 
    summarize(msw_strat = weighted.mean(musw_strat, stratum_area, na.rm = TRUE),
              m_nfish_strat = weighted.mean(munfish_strat, stratum_area, na.rm = TRUE),
              num_stra = n())
  
  
  meansw_s_ply <- pymean_strat %>% 
    group_by(svspp, year, season, pycode) %>%
    summarize(meansw_s = msw_strat/m_nfish_strat)
  
  meansw_ply <- pysum_m %>% 
    group_by(svspp, year, season, pycode) %>%
    summarize(meansw = weighted.mean(musw, rcatnum, na.rm = TRUE),
              num_tows = n())
  
  master_ply <- pysum_m %>% #musw and musw2
    left_join(pysum_wm_s) %>%  #tmsw_strat
    left_join(musw_strat_ply) %>% # musw_strat
    left_join(meansw_ply) %>% # meansw
    left_join(meansw_s_ply) %>% # meansw_s
    left_join(pymean_strat) %>%     # msw_strat
    select(-munfish_strat) %>% 
    mutate(prod = rcatnum^2 * ((musw - meansw))^2,
           prodf = (rcatnum - m_nfish_strat)^2,
           prodd = (musw2 - musw_strat)^2,
           prod_cov = (rcatnum - m_nfish_strat) * (musw2 - musw_strat))# %>% 
  
  mprod_mnumfish2_ply <- master_ply %>%
    group_by(svspp, year, season, pycode) %>%
    summarize(mprod = mean(prod, na.rm = TRUE),
              mnumfish = mean(rcatnum, na.rm = TRUE))
  
  new4_ply <- master_ply %>% 
    group_by(svspp, year, season, pycode) %>% 
    summarize(sprod = sum(prod, na.rm = TRUE),
              mprod = mean(prod, na.rm = TRUE),
              mnumfish = mean(rcatnum, na.rm = TRUE))
  
  new6_ply <- master_ply %>% 
    group_by(svspp, year, season,
             pycode, cruise6, stratum,
             stratum_area, rtot_tows_spp_stratum,
             m_nfish_strat) %>%
    summarize(sprodf = sum(prodf, na.rm = TRUE),
              sprodd = sum(prodd, na.rm = TRUE),
              sprod_cov = sum(prod_cov, na.rm = TRUE)) %>% 
    ungroup() %>% 
    mutate(dfntows_strat = rtot_tows_spp_stratum - 1,
           varprodf = (stratum_area^2) * ((sprodf/dfntows_strat)/rtot_tows_spp_stratum),
           varprodd = (stratum_area^2) * ((sprodd/dfntows_strat)/rtot_tows_spp_stratum),
           varprod_cov = (stratum_area^2) * ((sprod_cov/dfntows_strat)/rtot_tows_spp_stratum),
           varprodf = if_else(rtot_tows_spp_stratum > 1,
                              varprodf,
                              0),
           varprodd = if_else(rtot_tows_spp_stratum > 1,
                              varprodd,
                              0),
           varprod_cov = if_else(rtot_tows_spp_stratum > 1, 
                                 varprod_cov,
                                 0))
  
  sumvarprod_ply <- new6_ply %>% 
    group_by(svspp, year, season, pycode) %>%
    summarize(svarprodf = sum(varprodf, na.rm = TRUE),
              svarprodd = sum(varprodd, na.rm = TRUE),
              svarprod_cov = sum(varprod_cov, na.rm = TRUE),
              stratum_area = sum(stratum_area, na.rm = TRUE)) %>% 
    ungroup() %>% 
    mutate(varf = svarprodf / stratum_area^2,
           vard = svarprodd/ stratum_area^2,
           var_cov = svarprod_cov/ stratum_area^2) %>% 
    select(-stratum_area)
  
  new4_strat_ply <- new4_ply %>% 
    left_join(sumvarprod_ply) 
  
  
  #merge with  select master columns
  six_ply <- new4_strat_ply %>%
    left_join(master_ply) %>% 
    mutate(variance = ifelse(num_tows > 1 & mnumfish != 0 & meansw!=0 & m_nfish_strat !=0 & meansw_s!=0,
                             1/(num_tows * (mnumfish)^2) * (sprod/(num_tows-1)),
                             0),
           cv = ifelse(num_tows > 1 & mnumfish != 0 & meansw != 0 & m_nfish_strat != 0 & meansw_s != 0,
                       ((variance)^0.5)/meansw,
                       0),
           var_s = ifelse(num_tows > 1 & mnumfish != 0 & meansw != 0 & m_nfish_strat != 0 & meansw_s != 0,
                          (meansw_s^2) * ((varf/(m_nfish_strat^2)) + (vard/(msw_strat^2)) - (2 * var_cov/m_nfish_strat/msw_strat)),
                          0),
           cv_s = ifelse(num_tows > 1 & mnumfish != 0 & meansw != 0 & m_nfish_strat != 0 & meansw_s != 0,
                         ((var_s)^0.5)/meansw_s,0)) %>% 
    select(pycode, svspp, year, season, meansw,
           meansw_s, num_tows, m_nfish_strat, num_stra, 
           variance, cv, var_s, cv_s, pycode) %>% 
    distinct(.keep_all = TRUE)
  
  final_ply <- six_ply %>% 
    mutate(pycode = as.factor(pycode)) %>% 
    left_join(py_list) %>% 
    left_join(nstom_df) %>% 
    group_by(svspp, year, season) %>% 
    mutate(totwt = sum(meansw, na.rm = TRUE),
           totwt_s = sum(meansw_s, na.rm = TRUE),
           relmsw = 100*(meansw/totwt),
           relmsw_s = 100*(meansw_s/totwt_s),
           ci = sqrt(variance/num_tows)*2,
           relci = (ci/totwt)*100,
           ci_s = sqrt(var_s/num_tows)*2,
           relci_s = (ci_s/totwt_s)*100) %>% 
    select(svspp, year, season, meansw, num_tows,
           variance, cv, prey = tax, totwt, 
           relmsw, ci, relci, nstom)
  
  
  # })
  return(final_ply)
  
}

# diet_ply <- final_ply %>%
#   select(year, season, prey, relmsw, num_tows) %>%
#   group_by(season, prey) %>%
#   filter(relmsw>0.01) %>%
#   filter(mean(relmsw)>10.0)
# 
# 
# diet <- final %>%
#   select(year, season, prey, relmsw, num_tows) %>%
#   group_by(season, prey) %>%
#   filter(relmsw>0.01) %>%
#   filter(mean(relmsw)>10.0)
# 
# 
# library(ggplot2)
# compplot <- ggplot(diet, aes(year, relmsw, fill=prey)) +
#   geom_bar(stat = "identity") +
#   ylab("Percent in Diet") +
#   xlab("Year") +
#   facet_wrap("season", nrow=3) +
#   theme_bw() +
#   viridis::scale_fill_viridis(discrete = TRUE) +
#   theme(legend.position="bottom",
#         legend.text=element_text(size=5))
# 
# compplot_ply <- ggplot(diet_ply, aes(year, relmsw, fill=prey)) +
#   geom_bar(stat = "identity") +
#   ylab("Percent in Diet") +
#   xlab("Year") +
#   facet_wrap("season", nrow=3) +
#   theme_bw() +
#   viridis::scale_fill_viridis(discrete = TRUE) +
#   theme(legend.position="bottom",
#         legend.text=element_text(size=5))
# 
# library(patchwork)
# 
# compplot + compplot_ply
# compi <- compplot + geom_bar_interactive(stat = "identity", aes(tooltip = prey, data_id = prey))

# 
# ptm <- proc.time()
# 
# df_diet <- get_diet(103)
# ggiraph(code = print(df_diet), height=14)
# 
# out <- data.frame(t = (proc.time() - ptm)[3],
#                   sys = Sys.time())
# out


# d <- read.csv("~/attempts.csv")
# d <- d %>% arrange(time)
# plot(d$sys, type = "l")
# points(rep(mean(d$sys),nrow(d)))
```

Plot bluefish annual diet

```{r}

bluefish <- get_diet(135) 

p1 <-   ggplot(bluefish, aes(year, relmsw, fill=prey)) +
   geom_bar(stat = "identity") + #
   ylab("Percent in Diet") +
   xlab("Year") +
   facet_wrap("season", nrow=4) +
   theme_bw() +
   viridis::scale_fill_viridis(discrete = TRUE) +
   theme(legend.position = "none"
         #legend.position="bottom",
         #legend.text=element_text(size=5)
         ) +
    geom_bar_interactive(stat = "identity", aes(tooltip = prey, data_id = prey))

ggiraph(code = print(p1), height=14)  

```


