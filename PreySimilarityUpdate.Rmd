---
title: "Prey Similarlity Update"
author: "Sarah Gaichas"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_fold: hide
link-citations: yes
csl: ices-journal-of-marine-science.csl
bibliography: FishDiet_EcoIndicators.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)
library(here)
library(DT)
library(pdftools)
library(patchwork)
library(ggiraph)

library(ecodata)

```

## Update prey overlap analysis

For bluefish forage index modeling, we are selecting a set of predators that have high diet similarity to bluefish. 

@garrison_dietary_2000 evaluated similarity of predator diets on the Northeast US shelf to develop foraging guilds. They used NEFSC bottom trawl survey data 1973-1997. We are using diets from 1985-2020 to characterize the prey index. Therefore an additional 20+ years of diet information is available to assess whether predator diet similarity has changed. In addition, identifying the predators with the most similar diets (and foraging habits) to bluefish is useful for this analysis.

### Methods

@garrison_dietary_2000 used hierarchical agglomerative clustering to evaluate groups of species with similar diets. Specifically, the Schoener similarity index [@schoener_nonsynchronous_1970] was applied

>to assess the dietary overlap, Dij, between predator pairs:

$$ D_{i,j} = 1 – 0.5 (∑ |p_{i,k} – p_{j,k}|) $$

>where $p_{i,k}$ = mean proportional volume of prey type k in predator i and $p_{i,k}$ = mean proportional volume of
prey type k in predator j. 

@garrison_dietary_2000 used a set of 52 prey categories to characterize diet. This does not correspond to current standardized prey categories, which range from highly aggregated general categories ("gencat") through analysis categories ("analcat") and collection categories ("collcat"). Lowest possible taxonomic information is "pynam" and the number of prey groups within each category is:

```{r}
# object is called `allfh`
load(url("https://github.com/Laurels1/Condition/raw/master/data/allfh.RData"))
```

```{r}
gencomlist <- allfh %>%
  select(pynam, gencat, analcat, collcat, gencom2, analcom3) 

gencomlist %>%
  summarise_all(n_distinct)

```

It seems we could either reconstruct the categories from @garrison_dietary_2000 or use the "analcom" category. Over 100 prey categories may be a bit much. Alternatively, additional detail on prey may help identify which piscivores are closest to bluefish. Scott is using a list of 56 prey categories that may be close enough to the orignal list.

```{r}
preycats <- read_csv(here("fhdat/prey_categories.csv"))
```

The mean proportions were presumably taken over the entire time period 1973-1997 for the entire Northeast US shelf (survey area) and did not distinguish between seasons.

We could try to reproduce the original time period, add all years up to recent, do only 1997-recent, or some combination.

Also, we may want to include a different list of predators based on sample size. How many of each predator were observed in the earlier time period vs the later?

```{r}
predn <- allfh %>%
  mutate(yearrange = case_when(year < 1998 ~ "early, 1973-1997",
                               year > 1997 ~ "recent, 1998-2020",
                               TRUE ~ as.character(NA))) %>%
  select(yearrange, pdcomnam) %>%
  group_by(yearrange, pdcomnam) %>%
  summarise(count = n()) %>%
  pivot_wider(names_from = yearrange, values_from = count)

datatable(predn)
```

There is a table on they [NEFSC shiny app](https://fwdp.shinyapps.io/tm2020/#4_DIET_OVERLAP_AND_TROPHIC_GUILDS) that updates feeding guilds based on 50 predators, including striped bass, so perhaps we can use that instead of re-doing this whole analysis.

```{r}
dietoverlap <- read_csv(here("datfromshiny/tgmat.2022-02-15.csv"))
```
 This can be input into a cluster analysis:
 
```{r, fig.height=10}
# follows example here https://cran.r-project.org/web/packages/dendextend/vignettes/Cluster_Analysis.html

library(dendextend)

d_dietoverlap <- dist(dietoverlap)

guilds <- hclust(d_dietoverlap)

#plot(guilds)

dend <- as.dendrogram(guilds)

dend <- rotate(dend, 1:136)

dend <- color_branches(dend, k=5)

labels(dend) <- paste(as.character(names(dietoverlap[-1]))[order.dendrogram(dend)],
                           "(",labels(dend),")", 
                           sep = "")

dend <- hang.dendrogram(dend,hang_height=0.1)

# reduce the size of the labels:
# dend <- assign_values_to_leaves_nodePar(dend, 0.5, "lab.cex")
dend <- set(dend, "labels_cex", 0.5)
# And plot:
par(mar = c(3,3,3,7))
plot(dend, 
     main = "Clustered NEFSC diet data
     (the labels give the predator species/size)", 
     horiz =  TRUE,  nodePar = list(cex = .007))
#legend("topleft", legend = iris_species, fill = rainbow_hcl(3))
```
 
Another visualization
```{r}
par(mar = rep(0,4))
circlize_dendrogram(dend)
```

How much difference does clustering method make?
```{r}
# again directly from https://cran.r-project.org/web/packages/dendextend/vignettes/Cluster_Analysis.html
hclust_methods <- c("ward.D", "single", "complete", "average", "mcquitty", 
        "median", "centroid", "ward.D2")
diet_dendlist <- dendlist()
for(i in seq_along(hclust_methods)) {
   hc_diet <- hclust(d_dietoverlap, method = hclust_methods[i])   
   diet_dendlist <- dendlist(diet_dendlist, as.dendrogram(hc_diet))
}
names(diet_dendlist) <- hclust_methods
#diet_dendlist
```

Correlations between clustering methods
```{r}
diet_dendlist_cor <- cor.dendlist(diet_dendlist)
#diet_dendlist_cor
corrplot::corrplot(diet_dendlist_cor, "pie", "lower")
```

Comparison of clusters
```{r, fig.height=10}
par(mfrow = c(4,2))
for(i in 1:8) {
   diet_dendlist[[i]] %>% set("branches_k_color", k=5) %>% plot(axes = FALSE, horiz = TRUE)
   title(names(diet_dendlist)[i])
}
```

Compare complete (default) and average
```{r}
diet_dendlist %>% dendlist(which = c(3,4)) %>% ladderize %>% 
   untangle(method = "step1side", k_seq = 2:6) %>%
   set("branches_k_color", k=5) %>% 
   tanglegram(faster = TRUE) # 
   #tanglegram(common_subtrees_color_branches = TRUE)
```
Compare complete and mcquitty
```{r}
diet_dendlist %>% dendlist(which = c(3,5)) %>% ladderize %>% 
   untangle(method = "step1side", k_seq = 2:6) %>%
   set("branches_k_color", k=5) %>% 
   tanglegram(faster = TRUE) # 
```
Compare complete and wardD
```{r}
diet_dendlist %>% dendlist(which = c(3,1)) %>% ladderize %>% 
   untangle(method = "step1side", k_seq = 2:6) %>%
   set("branches_k_color", k=5) %>% 
   tanglegram(faster = TRUE) # 
```

See about common nodes between methods, looks better

```{r}
diet_dendlist_cor2 <- cor.dendlist(diet_dendlist, method = "common")
#iris_dendlist_cor2
corrplot::corrplot(diet_dendlist_cor2, "pie", "lower")

```

Maybe we go with ward.D2 which seems most consistent across methods?
```{r, fig.height=10}
d_dietoverlap <- dist(dietoverlap)

guilds <- hclust(d_dietoverlap, method = "ward.D2")

#plot(guilds)

dend <- as.dendrogram(guilds)

dend <- rotate(dend, 1:136)

dend <- color_branches(dend, k=5)

labels(dend) <- paste(as.character(names(dietoverlap[-1]))[order.dendrogram(dend)],
                           "(",labels(dend),")", 
                           sep = "")

dend <- hang.dendrogram(dend,hang_height=0.1)

# reduce the size of the labels:
# dend <- assign_values_to_leaves_nodePar(dend, 0.5, "lab.cex")
dend <- set(dend, "labels_cex", 0.5)
# And plot:
par(mar = c(3,3,3,7))
plot(dend, 
     main = "Clustered NEFSC diet data
     (the labels give the predator species/size)", 
     horiz =  TRUE,  nodePar = list(cex = .007))
```

### Results

If we trim the dendogram down we can better see the distinctions within piscivores:
```{r}

```



## References