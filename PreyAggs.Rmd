---
title: "Prey data and aggregation"
author: "Sarah Gaichas"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_fold: hide
link-citations: yes
csl: ices-journal-of-marine-science.csl
bibliography: FishDiet_EcoIndicators.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)
library(here)
library(DT)
library(pdftools)
library(patchwork)
library(ggiraph)

library(ecodata)
#library(VAST)
```

Use food habits data from Laurel's condition repository, object is called `allfh`

```{r}
load(url("https://github.com/Laurels1/Condition/raw/master/data/allfh.RData"))
```

Range of years in `allfh` :

`r unique(allfh$year)`

Following data prep in @ng_predator_2021. First collapsed to first and second half of year, combining winter and summer surveys with spring and fall to expand datasets. 

Want to compute the average mass of each prey category for combined predators per tow. Predator-specific covariates need to also be averaged by tow (size, Nspecies, evenness?).

First explore, how many predators per tow, how many stomachs each, how many prey in each predator? Filter to piscivores first. 

```{r}
# code for piscivore table
piscivores <- ecodata::species_groupings %>%
  select(COMNAME, SizeCat, Garrison.Link) %>%
  filter(!is.na(Garrison.Link),
         Garrison.Link == "Piscivores") %>%
  mutate(PiscGuild = case_when(COMNAME == "WINTER SKATE" ~ "c",
                               COMNAME == "WEAKFISH" ~ "b", 
                               COMNAME == "BLUEFISH" & SizeCat == "S" ~ "b",
                               TRUE ~ "a")) %>%
  distinct()

# same as Scott's?
guild_dat <- read.csv("fhdat/predator_guilds.csv", stringsAsFactors = FALSE)

pisc2 <- guild_dat %>%
  filter(guild %in% "piscivore")

# no, typo in Scott's BSB should not be a piscivore and bluefish S and M missing

rm(pisc2, guild_dat)

# food habits 1973-2020 piscivores only; include empties

fh.nefsc.pisc <- allfh %>%
  #filter(pynam != "EMPTY") %>%
  left_join(piscivores, by = c("pdcomnam" = "COMNAME",
                               "sizecat" = "SizeCat")) %>%
  filter(!is.na(Garrison.Link))

 preycount <- fh.nefsc.pisc %>%
   #group_by(year, season, pdcomnam, pynam) %>%
   group_by(pdcomnam, pynam) %>%
   summarise(count = n()) %>%
   #arrange(desc(count))
   pivot_wider(names_from = pdcomnam, values_from = count)

```

How many times in the full dataset was each prey name observed per predator?

```{r}
datatable(preycount, rownames = FALSE,
          extensions = c("FixedColumns"),
          #caption = "Prey observed in piscivores guild (Garrison and Link 2000) 1973-2020",
          options = list(pageLength = 25,
                         scrollX = TRUE,
                         fixedColumns = list(leftColumns = 1)))
```

Start by aggregating all pelagic nekton prey that have at least 10 observations for bluefish (leaving out empty, fish, osteichthes, AR, blown):

```{r}

gencomlist <- fh.nefsc.pisc %>%
  select(pynam, gencom2) %>%
  distinct()

blueprey <- preycount %>%
  filter(BLUEFISH > 9) %>%
  filter(!pynam %in% c("EMPTY", "BLOWN",
                       "FISH", "OSTEICHTHYES",
                       "ANIMAL REMAINS",
                       "FISH SCALES")) %>%
  #filter(!str_detect(pynam, "SHRIMP|CRAB")) %>%
  left_join(gencomlist) %>%
  filter(!gencom2 %in% c("ARTHROPODA", "ANNELIDA",
                         "CNIDARIA", "UROCHORDATA",
                         "ECHINODERMATA", "WORMS",
                         "BRACHIOPODA", "COMB JELLIES",
                         "BRYOZOA", "SPONGES",
                         "MISCELLANEOUS", "OTHER"))
```

```{r}
datatable(blueprey, rownames = FALSE,
          extensions = c("FixedColumns"),
          #caption = "Bluefish prey in all piscivores 1973-2020",
          options = list(pageLength = 25,
                         scrollX = TRUE,
                         fixedColumns = list(leftColumns = 1)))
```

This gives us 20 individual prey names. 

We should compare this list with NEAMAP bluefish prey to see if any are missing.

Filter dataset to these preynames, then look at summary stats of prey per tow, predators per tow by season each year.

```{r}
fh.nefsc.pisc.blueprey <- fh.nefsc.pisc %>%
  mutate(blueprey = case_when(pynam %in% blueprey$pynam ~ "blueprey",
                              TRUE ~ "othprey"))

preystn <- fh.nefsc.pisc.blueprey %>%
  group_by(year, season, station) %>%
  count(blueprey) %>%
  pivot_wider(names_from = blueprey, values_from = n) %>%
  group_by(year, season) %>%
  
  summarise((!is.na(othprey)),
            count(!is.na(blueprey)))

```

Possible prey categories:  

+  Inshore fish (menhaden, bay anchovy, engraulidae?, sandlance, spot?)
+  Offshore fish (Atl herring/clupeidae, Atl mackerel/scomber, butterfish, hakes)
+  Inshore squid (Loligo)
+  Offshore squid (Illex)
+  Other (AR, misc, inverts other than squid) No, skip this.

Presence of family level categories (Cephalopoda, Engraulidae) makes habitat splitting difficult.
Do some dynamic mapping if engraulidae mostly with anchoa make inshore? 
If cephalapods with loligo make inshore; Illex offshore?
Circular though.