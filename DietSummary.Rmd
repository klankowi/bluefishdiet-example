---
title: "Bluefish Diet Summaries for 2022 RTA"
author: "Sarah Gaichas"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_fold: hide
link-citations: yes
csl: plos.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)
library(here)
library(DT)
library(pdftools)
library(patchwork)
library(ggiraph)


```

## Data sources

For the 13 October 2021 Bluefish WG meeting, we pulled summary diet information from the [NEFSC Diet Data shiny app, Fish Trophic Ecology of the Northeast U.S. Continental Shelf, by Smith B.E. & Rowe S., dated 9/20/2021](https://fwdp.shinyapps.io/tm2020/). These data were pulled 7 October 2021 and were saved in the `datfromshiny` folder in this repository.

NEAMAP diets were queried using the [VIMS food habits data summary web interface](https://www.vims.edu/research/departments/fisheries/programs/mrg_oldwebsite/interaction/fish_food_habits/index.php) on 14 July 2021. Using the VIMS "prey centered data report" The file `bluefishaspreyVIMS.pdf`was retrieved.

Need to investigate whether any other state or inshore surveys collect diet data and add.

## Bluefish as prey

### Who eats bluefish? NEFSC bottom trawl survey

```{r}

bluefishpreds <- read_csv(here("datfromshiny","WEW.Bluefish (Pomatomus saltatrix).2021-10-07.csv"))

totobs <- sum(bluefishpreds$Frequency)
dompred <- bluefishpreds$Predator[which.max(bluefishpreds$Frequency)]
pctdompred <- max(bluefishpreds$Frequency)/totobs*100

```
The NEFSC bottom trawl survey has relatively few records of bluefish as prey.  From 1973-2020, `r totobs` bluefish were identified as prey in fish sampled for diet. Of these, `r dompred` had the most bluefish in stomachs; `r pctdompred`% of all observed.

```{r}
datatable(bluefishpreds[,-c(1:2)], rownames = FALSE,
          caption = 'Table 1: Who eats bluefish on the NEFSC bottom trawl survey. Nstom is total stomachs sampled for the predator, 1973-2020.')
```

### NEAMAP survey

Quick outputs of NEFSC and NEAMAP surveys are not direcly comparable (NEAMAP doesn't say how many times bluefish were observed). However, NEAMAP but does give a % of predator diet for all predators where bluefish were observed in stomachs. Looks like sandbar sharks and striped bass eat them inshore (likely as juveniles).

```{r}
bluefishpredsNEAMAP <- pdf_text(here("datfromVIMS","bluefishaspreyVIMS.pdf")) %>%
  stringr::str_split('\n', simplify = T) %>%
  matrix(ncol = 1)

# tab_start <- stringr::str_which(bluefishpredsNEAMAP, "                                         bluefish")
# tab_end <- stringr::str_which(bluefishpredsNEAMAP, "                       striped bass                     8.8          352         195" )
# tab <- bluefishpredsNEAMAP[(tab_start+1):(tab_end-1), 1] %>%
#   str_replace_all('\\s{2,}', '\t')
# text_conn <- textConnection(tab)
# df <- read.csv(text_conn, sep = '\t', skip = 1)

#wont work but placeholder
bluefishpredsNEAMAP
```


Full striped bass NEAMAP diet data as well as full diet data for sandbar sharks in either numbers or weight are available in the `datfromVIMS` folder. Jim Gartland is showing a much better summary for NEAMAP and ChesMMAP data.

### Literature search (to be expanded)  

Quick research found the following links showing that (adult) bluefish are eaten by [mako sharks](https://web.uri.edu/wetherbee/predator-prey-interactions-between-mako-sharks-isurus-oxyrinchus-and-bluefish-pomatomus-saltatrix/) (Tony Wood, primary author) and have been found in [swordfish](http://www.int-res.com/articles/meps/22/m022p239.pdf) diets.

I found one paper looking at [bluefish cannibalism on juveniles](https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1095-8649.1999.tb00734.x); but nothing else on consumption of juvenile bluefish by predators. There may be more info. We looked at bluefish diets for a previous benchmark assessment and did see some cannibalism; see Fig B5.7, p.522 of [this doc](https://repository.library.noaa.gov/view/noaa/4975)).

## Bluefish as predators

### NEFSC bottom trawl survey diet summaries

Diet summaries from the shiny app use different prey categories depending on the summary. We'll read them all in here to get a list of unique prey across all summaries. 
```{r, readdiets}
bluefishaggdiet <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).All.2021-10-07.csv"))

# decadal diet
diet70 <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).1970s.2021-10-07.csv")) %>%
  mutate(Decade = 1970)
diet80 <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).1980s.2021-10-07.csv"))%>%
  mutate(Decade = 1980)
diet90 <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).1990s.2021-10-07.csv"))%>%
  mutate(Decade = 1990)
diet00 <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).2000s.2021-10-07.csv"))%>%
  mutate(Decade = 2000)
diet10 <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).2010s.2021-10-07.csv"))%>%
  mutate(Decade = 2010)

bluefishdecadediet <- bind_rows(diet70, diet80, diet90, diet00, diet10)

# seasonal diet
dietspring <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).SPRING.2021-10-07.csv"))%>%
  mutate(Season = "Spring")
dietfall <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).FALL.2021-10-07.csv"))%>%
  mutate(Season = "Fall")

bluefishseasondiet <- bind_rows(dietspring, dietfall)

# regional diet
dietMAB <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).MID-ATLANTIC BIGHT.2021-10-07.csv")) %>%
  mutate(Region = "MAB")
dietSNE <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).SOUTHERN NEW ENGLAND.2021-10-07.csv"))%>%
  mutate(Region = "SNE")
dietGB <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).GEORGES BANK.2021-10-07.csv"))%>%
  mutate(Region = "GB")

bluefishregiondiet <- bind_rows(dietMAB, dietSNE, dietGB)

# bluefish size diet
dietSM <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).S.2021-10-07.csv")) %>%
  mutate(Size = "Small")
dietMED <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).M.2021-10-07.csv"))%>%
  mutate(Size = "Medium")
dietLG <- read_csv(here("datfromshiny","DC.Bluefish (Pomatomus saltatrix).L.2021-10-07.csv"))%>%
  mutate(Size = "Large")

bluefishsizediet <- bind_rows(dietSM, dietMED, dietLG)

preylist <- unique(c(bluefishaggdiet$Prey, bluefishdecadediet$Prey, bluefishregiondiet$Prey, bluefishseasondiet$Prey, bluefishsizediet$Prey))

```

We will define the colors used for the prey categories and use them consistently throughout the analyses. These can be changed here and carried through all subsequent plots. There is no way to really keep track of these in the plots below, so click a bar to get that bar highlighted with a prey name.

```{r}
#from http://medialab.github.io/iwanthue/ using 35 categories, colorblind friendly
# again from http://medialab.github.io/iwanthue/ All colors colorspace, colorblind friendly, hard
preycol <- c("#00495d",
"#3ac100",
"#a646f7",
"#72ff75",
"#8d00a6",
"#c6ff90",
"#0268f1",
"#ff8d23",
"#0144a6",
"#01a249",
"#e1009e",
"#abffe1",
"#7e0082",
"#fffdd4",
"#24001c",
"#bbf6ff",
"#a60029",
"#0176c8",
"#8a4700",
"#a083ff",
"#454400",
"#ff7fff",
"#005d35",
"#c9005e",
"#00483e",
"#ff96e4",
"#291d00",
"#d5a5ff",
"#2e0400",
"#ffc5d6",
"#00285f",
"#ffbb88",
"#4a002e",
"#ff8092",
"#68001a")
names(preycol) <- as.factor(preylist)

```

```{r}
dfpreycol <- as.data.frame(preycol) %>%
  rownames_to_column(var = "preyname")

preycolplot <- ggplot(dfpreycol, aes(x=preyname, weight=1, fill=preycol)) + 
  geom_bar() +
  scale_fill_manual(values=preycol) 

library(gridExtra)
library(grid)
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

preykey <- g_legend(preycolplot)
grid.draw(preykey)

```

#### Bluefish diet in aggregate (all years, regions, and bluefish sizes), 1973-2020 {.tabset}

##### Plot
```{r}
p <- ggplot(bluefishaggdiet, aes(x=as.factor("Aggregate"), y=Pct.m, fill=Prey)) +
  geom_bar_interactive(width = 0.95, stat = "identity", show.legend = FALSE,
                       aes(tooltip = Prey, data_id = Prey))+
  scale_fill_manual(values=preycol) +         #custom colors
  ggthemes::theme_tufte()
ggiraph(code=print(p))
```

##### Table
```{r}
datatable(bluefishaggdiet[,-c(1:2, 10)], rownames = FALSE,
          caption = 'Table 3: Bluefish prey from all samples combined.')
```

#### {-}

#### Bluefish diet by season (all years, regions, and bluefish sizes) {.tabset}

##### Plot
```{r}
p <- ggplot(bluefishseasondiet, aes(x=as.factor(Season), y=Pct.m, fill=Prey)) +
  geom_bar_interactive(width = 0.95, stat = "identity", show.legend = FALSE,
                       aes(tooltip = Prey, data_id = Prey))+
  scale_fill_manual(values=preycol) +         #custom colors
  ggthemes::theme_tufte()
ggiraph(code=print(p))
```

##### Table
```{r}
datatable(bluefishseasondiet[,-c(1:2, 10)], rownames = FALSE,
          caption = 'Table 4: Bluefish prey by season, 1973-2020.')
```

#### {-}

#### Bluefish diet by decade (all regions and bluefish sizes) {.tabset} 

##### Plot
```{r}
p <- ggplot(bluefishdecadediet, aes(x=as.factor(Decade), y=Pct.m, fill=Prey)) +
  geom_bar_interactive(width = 0.95, stat = "identity", show.legend = FALSE,
                       aes(tooltip = Prey, data_id = Prey))+
  scale_fill_manual(values=preycol) +         #custom colors
  ggthemes::theme_tufte()
ggiraph(code=print(p))
```

##### Table
```{r}
datatable(bluefishdecadediet[,-c(1:2, 10)], rownames = FALSE,
          caption = 'Table 5: Bluefish prey by decade, 1973-2020.')
```

#### {-}

#### Bluefish diet by region (all years and bluefish sizes) {.tabset}  

##### Plot
```{r}
p <- ggplot(bluefishregiondiet, aes(x=as.factor(Region), y=Pct.m, fill=Prey)) +
  geom_bar_interactive(width = 0.95, stat = "identity", show.legend = FALSE,
                       aes(tooltip = Prey, data_id = Prey))+
  scale_fill_manual(values=preycol) +         #custom colors
  ggthemes::theme_tufte()
ggiraph(code=print(p))
```

##### Table
```{r}
datatable(bluefishregiondiet[,-c(1:2, 10)], rownames = FALSE,
          caption = 'Table 6: Bluefish prey by region, 1973-2020.')
```

#### {-}

#### Bluefish diet by bluefish size (all years and regions) {.tabset}

##### Plot
```{r}
p <- ggplot(bluefishsizediet, aes(x=as.factor(Size), y=Pct.m, fill=Prey)) +
  geom_bar_interactive(width = 0.95, stat = "identity", show.legend = FALSE,
                       aes(tooltip = Prey, data_id = Prey))+
  scale_fill_manual(values=preycol) +         #custom colors
  ggthemes::theme_tufte()
ggiraph(code=print(p))

```

##### Table
```{r}
datatable(bluefishsizediet[,-c(1:2, 10)], rownames = FALSE,
          caption = 'Table 7: Bluefish prey by bluefish size, 1973-2020.')
```

#### {-}

