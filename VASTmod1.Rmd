---
title: "VAST take 1"
author: "Sarah Gaichas"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_fold: hide
link-citations: yes
csl: ices-journal-of-marine-science.csl
bibliography: FishDiet_EcoIndicators.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)
library(here)
#library(DT)
#library(pdftools)
#library(patchwork)
#library(ggiraph)

#library(ecodata)
library(VAST)
```

Having built an initial dataset of haul-specific mean bluefish prey weight per stomach for piscivores, now we'll try to get a forage biomass index using VAST.

The approach here is to use exactly what @ng_predator_2021 for herring, but combining all bluefish prey (defined [here](https://sgaichas.github.io/bluefishdiet/PreyAggs.html)) as sampled by all piscivore predators at each station.

In @ng_predator_2021, seasons were modeled separately, so we will start that way as well. They used 100 knots, estimated by k-means clustering of the data, to define the spatial dimensions of each seasonal model. They used a a Poisson-link delta model to estimate expected prey mass per predator stomach.  

Read in data, separate spring and fall, and rename columns for VAST:

```{r}
bluepyagg_stn <- readRDS(here("fhdat/bluepyagg_stn.rds"))

bluepyagg_stn_fall <- bluepyagg_stn %>%
  ungroup() %>%
  filter(season_ng == "FALL") %>%
  mutate(Vessel = "NEFSC",
         AreaSwept_km2 = 0.0384) %>%
  select(Catch_KG = meanbluepywt,
         Year = year,
         Vessel,
         AreaSwept_km2,
         Lat = declat,
         Lon = declon) %>%
  as.data.frame()

bluepyagg_stn_spring <- bluepyagg_stn %>%
  filter(season_ng == "SPRING")%>%
  mutate(Vessel = "NEFSC",
         AreaSwept_km2 = 0.0384) %>%
  select(Catch_KG = meanbluepywt,
         Year = year,
         Vessel,
         AreaSwept_km2,
         Lat = declat,
         Lon = declon)%>%
  as.data.frame()
```

Try the simplest possible index standardization model, fall:

```{r, eval=FALSE}
# modified from https://github.com/James-Thorson-NOAA/VAST/wiki/Index-standardization
# and https://github.com/NOAA-EDAB/neusvast/blob/master/analysis/models/pisc_pesc.R

season <- c("fall")

working_dir <- here::here(sprintf("pyindex/allagg_%s/", season))

if(!dir.exists(working_dir)) {
  dir.create(working_dir)
}

# Make settings (turning off bias.correct to save time for example)
settings = make_settings( n_x = 100, 
  Region = "northwest_atlantic", 
  purpose = "index2", 
  bias.correct = FALSE,
  strata.limits = list('All_areas' = 1:1e5))

######## Change settings from defaults
settings$ObsModel = c( 2, 1 ) #make_data()
settings$Options[2:4] = FALSE
settings$use_anisotropy = FALSE
settings$fine_scale = TRUE

# Run model
fit = fit_model( settings = settings, 
  Lat_i = bluepyagg_stn_fall[,'Lat'], 
  Lon_i = bluepyagg_stn_fall[,'Lon'], 
  t_i = bluepyagg_stn_fall[,'Year'], 
  b_i = bluepyagg_stn_fall[,'Catch_KG'],
  a_i = bluepyagg_stn_fall[,'AreaSwept_km2'], 
  working_dir = paste0(working_dir, "/"))

# Plot results
plot( fit )
```

