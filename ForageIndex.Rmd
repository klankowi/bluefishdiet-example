---
title: "Bluefish forage index"
author: "Sarah Gaichas"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_fold: hide
link-citations: yes
csl: ices-journal-of-marine-science.csl
bibliography: FishDiet_EcoIndicators.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)
library(here)
library(DT)
library(pdftools)
library(patchwork)
library(ggiraph)

library(ecodata)
library(VAST)
```

# Does prey drive availability of bluefish?

## What are bluefish prey?

Bluefish eat small pelagics that are not well sampled by bottom trawl surveys. Bluefish themselves are not well sampled by bottom trawl surveys. Nevertheless, the diet samples collected for bluefish indicate that anchovies, herrings, squids, butterfish, scup, and small hakes are important prey. 

See [here](https://sgaichas.github.io/bluefishdiet/DietSummary.html) for NEFSC survey and [here](https://docs.google.com/presentation/d/1VlP0OsSLnoaoFHHt7kJbrqNTgBJqI6Ru/edit#slide=id.p1) for NEAMAP survey bluefish diet composition summaries.

## Has the total amount of bluefish prey changed over time?

Because bluefish prey are mainly small pelagic species not well sampled by trawl surveys, direct estimates of prey biomass from trawl surveys are unlikely to be useful to understand changes in prey biomass over time. However, we could still try this in aggregate if we have time.

Multiple predators that are more effectively sampled by trawl surveys also consume bluefish prey. Therefore, using a suite of predators as "samplers" of bluefish prey may more effectively estimate changes in prey over time. This method has been applied to develop an index of Atlantic herring in the Northeast US using the NEFSC bottom trawl survey diet data [@ng_predator_2021]. In our case, we will want to apply the method to multiple prey rather than a single prey species.

It may be useful to track prey categories from predator diets (family level aggregation) rather than species level or fully aggregated "prey". We can evaluate how much data is available at each level of aggregation. 

Hypothesis: we would not expect significant changes over time in an index aggregate prey biomass over bluefish's range; they prey on a wide variety of species. However, we may see fluctuations in prey types that could be informative.

Caveat: the surveys here do not cover bluefish's range (sparse south of Cape Hatteras).

## Has the spatial distribution of bluefish prey changed over time?

To evaluate whether bluefish prey distribution has changed, we should (at a minimum) combine nearshore and offshore surveys in as many seasons as feasible. The NEFSC and NEAMAP bottom trawl surveys both operate in spring and fall, and have been combined to analyze changes in biomass and distribution of summer flounder [@perretti_spatio-temporal_2019]. 

# Methods

We will use VAST [@thorson_comparing_2017; @thorson_guidance_2019] to evaluate changes in bluefish prey biomass and distribution over time.  

## Decisions

### Which predators to include?

Fish feeding guilds based on dietary overlap have been defined for the Northeast US shelf based on NEFSC trawl survey diet data from 1973-1997 [@garrison_dietary_2000]. In this analysis, all size classes of bluefish were classified as piscivores. A reasonable first cut would be to use all predator/size combinations identifed as piscivores in @garrison_dietary_2000. This would include:

```{r}

piscivores <- ecodata::species_groupings %>%
  select(COMNAME, SizeCat, Garrison.Link) %>%
  filter(!is.na(Garrison.Link),
         Garrison.Link == "Piscivores") %>%
  mutate(PiscGuild = case_when(COMNAME == "WINTER SKATE" ~ "c",
                               COMNAME == "WEAKFISH" ~ "b", 
                               COMNAME == "BLUEFISH" & SizeCat == "S" ~ "b",
                               TRUE ~ "a")) %>%
  distinct()

datatable(piscivores, rownames = FALSE,
          caption = "Piscivores feeding guild from Garrison and Link 2000",
          options = list(pageLength = 25))

```

### Should predators be aggregated prior to analysis or kept separate?

Options are each predator and size class in the piscivore guild separate, each predator separate (aggregate size), each piscivore guild separate ("a", "b", and "c"), or all piscivores combined.

Should we account for predator size in an aggregation? @garrison_dietary_2000 noted that small bluefish along with weakfish formed a subset of piscivores with predominantly anchovy prey (PiscGuild "b" in the table). Large summer flounder and large sharpnose sharks had the highest similarity to medium and large bluefish, but were not distinguished as a subset of the guild from the remaining piscivores [@garrison_dietary_2000]. Winter skates were a separate piscivore guild "c" so we could keep them or not.

There have been 20+ more years of data collected since this analysis. It seems unlikely that this list would change much, but if we had Lance's code we could possibly rerun? Maybe Brian has? 

*Is it useful for the assessment to characterize prey of small (up to 30 cm) bluefish separately from 31+ cm bluefish?* If so we could separate these predator guilds. There may be more weakfish diet data in the NEAMAP survey than in the NEFSC survey, so joining the surveys will be important if we want to do this.

### How to aggregate prey?

Taxonomic? Size? Habitat? Combination?

## Data

### NEFSC bottom trawl diet data

Initial test food habits dataset from [2018 ECSA](https://github.com/NOAA-EDAB/ECSA/blob/master/data/allfhsg.RData) has food habits 1973 - 2016. Will get fuller up to date info from Brian Smith shortly.

```{r}

load(here("fhdat", "allfhsg_2016.RData"))

fh.nefsc.pisc <- allfhsg %>%
  filter(pynam != "EMPTY") %>%
  left_join(piscivores, by = c("pdcomnam" = "COMNAME",
                               "sizecat" = "SizeCat")) %>%
  filter(!is.na(Garrison.Link))

```

Here are size distributions of piscivores in my trial NEFSC diet dataset 1973-2016. We don't have weakfish in this dataset anyway:

```{r}

fh.nefsc.pisc %>%
  group_by(year, season, station, pdid) %>%
  ggplot(aes(x=pdlen, fill=pdcomnam)) +
  geom_histogram(stat = "count") +
  theme_minimal() +
  theme(legend.position = "none") +
  facet_wrap(~pdcomnam, scales = "free")


```



### NEAMAP bottom trawl diet data

## VAST model(s)



# Results


# Discussion


# References
